name: Sitemap Monitor
on:
  schedule:
    - cron: '0 0 * * *'  # 08:00 Beijing time (UTC+8)
  workflow_dispatch:

permissions:
  contents: write

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
        
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests cloudscraper pyyaml beautifulsoup4

    - name: Prepare runtime config
      env:
        FEISHU_WEBHOOK_URL: ${{ secrets.FEISHU_WEBHOOK_URL }}
      run: |
        python - <<'PY'
        import os
        import yaml

        path = "config.yaml"
        with open(path, "r") as f:
            data = yaml.safe_load(f) or {}

        data.setdefault("feishu", {})
        data["feishu"]["webhook_url"] = os.environ.get("FEISHU_WEBHOOK_URL", "")

        with open(path, "w") as f:
            yaml.safe_dump(data, f, sort_keys=False, allow_unicode=False)
        PY

    - name: Clear diff history
      run: rm -rf diff

    - name: Run Monitor
      run: python main.py

    - name: Restore config
      run: git checkout -- config.yaml

    - name: Commit changes
      run: |
        if [ -n "$(git status --porcelain)" ]; then
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add -A
          git commit -m "Update sitemap snapshots"
          git push
        else
          echo "No changes to commit."
        fi
